<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/layout :: title(#{electricity.title}, ~{::link})}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link type="text/css" rel="stylesheet" th:href="@{/css/electricity.css}" href="../static/css/electricity.css">
</head>

<body>
<header th:replace="~{fragments/layout :: sidebar}"></header>
<section th:id="electricity-section" id="electricity-section">
    <div class="noClient" th:if="${clientCodeList.size == 0}">
        <a href="#" th:href="@{/user/dashboard}" class="goBack btn btn-primary text-decoration-none scaleHover bi bi-arrow-return-left"></a>
        <div class="d-flex-inline">
            <p th:text="#{electricity.addFirstClientCode.label}">Add first client code</p>
            <a href="#" th:href="@{/user/dashboard/electricity/client-code}" class="noClientData text-decoration-none bi bi-person-plus"></a>
        </div>
    </div>
    <div class="card-group" th:unless="${clientCodeList.size == 0}">
        <div class="d-flex top-buttons">
            <div class="img-utility">
                <a href="#" th:href="@{/user/dashboard/electricity/client-code}" class="text-decoration-none" th:title="#{electricity.addClientCode.label}">
                    <img th:src="@{/images/user-dashboard/electricity.png}" src="../static/images/user-dashboard/electricity.png" class="scaleHover" alt="" width="75" height="75">
                </a>
            </div>

            <p class="utilityTitleText" th:text="#{electricity.title}"></p>

            <div class="ms-4 d-block w-100">
                <a href="#" th:href="@{/user/dashboard}" class="btn btn-primary goDashboard float-end text-decoration-none scaleHover bi bi-arrow-return-left" th:title="#{electricity.button.back.tooltip}"></a>
            </div>
        </div>
        <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                <button class="d-grid nav-link" id="nav-1-tab" th:title="#{electricity.contractSince.title} + ': ' + ${#temporals.format(client.getContractDate(), 'dd-MM-yyyy')}" th:each="client : ${clientCodeList}" th:classappend="${firstClient.getId()} == ${client.getId()} ? 'active':''" th:id="'nav' + ${client.getId()} + 'tab'" data-bs-toggle="tab" data-bs-target="#nav-1" th:data-bs-target="'#nav' + ${client.getId()}" type="button" role="tab" aria-controls="nav-1" th:aria-controls="'nav' + ${client.getId()}" aria-selected="true">
                    <div class="d-flex">
                        <a id="put1" th:id="'put' + ${client.getId()}" class="btn-primary text-primary text-decoration-none scaleHover bi bi-pencil-square"></a>
                        <a id="delete1" th:id="'delete' + ${client.getId()}" class="btn-primary text-decoration-none scaleHover bi bi-trash"></a>
                    </div>
                    <span th:text="${client.getClientNumber()}">client-code</span>
                    <span th:text="${client.getClientName()}">client-name</span>
                </button>
            </div>
        </nav>
        <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade" id="nav-1" th:classappend="${firstClient.getId()} == ${client.getId()} ? 'show active':''" th:each="client : ${clientCodeList}" th:id="'nav' + ${client.getId()}" role="tabpanel" aria-labelledby="nav-1-tab" th:aria-labelledby="'nav' + ${client.getId()} + 'tab'">
                <div class="row">
                    <div class="col-md-4 pe-0 justify-content-md-center">
                        <div class="card col clientsInfo" id="clientInfo" th:id="'clientInfo' + ${client.getId()}">
                            <div class="col bottom-info">
                                <a class="addInfoClass btn btn-primary text-decoration-none scaleHover" href="#" th:href="@{/user/dashboard/electricity/client-code/__${client.getId()}__/client-index}" th:text="#{electricity.addIndex.label}">Add new index</a>
                                <div class="cln container-fluid">
                                    <table class="table table-sm table-hover table-bordered text-center align-middle">
                                        <tbody>
                                            <tr class="table-no-bottom-border">
                                                <th th:text="#{electricity.consumptionNumber.title}">Number</th>
                                            </tr>
                                            <tr class="table-no-top-border">
                                                <td th:text="${client.getConsumptionLocationNumber()}">Number</td>
                                            </tr>
                                            <tr class="table-no-bottom-border">
                                                <th th:text="#{electricity.consumptionAddress.title}">Address</th>
                                            </tr>
                                            <tr class="table-no-top-border">
                                                <td th:text="${client.getConsumptionAddress()}">Address</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="card col clientsIndex" id="clientIndex" th:id="'clientIndex' + ${client.getId()}">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover table-bordered text-center align-middle">
                                    <thead class="position-sticky bg-white" style="top:0;">
                                        <tr>
                                            <th th:text="#{electricity.index.createdDate.title}">Created Date</th>
                                            <th th:text="#{electricity.index.title}" th:colspan="${#temporals.format(lastCreatedIndexDate, 'dd-MM-yyyy')} == ${#temporals.format(today, 'dd-MM-yyyy')} ? 2 : 1">Index</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="index : ${indexList}" th:if="${client.getId() == index.getClientId()}">
                                            <td th:text="${#temporals.format(index.getModifiedAt(), 'dd-MM-yyyy HH:mm:ss')}">Index date</td>
                                            <td th:text="${index.getValue()}">Index value</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8 justify-content-md-center charts">
                        <div class="card col-md-auto" id="clientGraph" th:id="'clientGraph' + ${client.getId()}">
                            <a id="switchChart" th:title="#{chart.button.switch.tooltip}" class="btn btn-primary text-decoration-none text-center scaleHover bi bi-arrow-repeat"></a>
                            <canvas id="indexChart" th:id="'indexChart' + ${client.getId()}"></canvas>
                            <div class="mt-3 d-flex justify-content-md-evenly text-center">

                                <div class="btn-group m-0" role="group" aria-label="Basic radio toggle button group">
                                    <input type="radio" class="btn-check" name="btnRadio" id="chartTypeWeek" autocomplete="off" checked>
                                    <label class="btn btn-outline-primary scaleHover bi bi-calendar-week" for="chartTypeWeek" th:text="'  ' + #{chart.week.button.label}">Week</label>

                                    <input type="radio" class="btn-check" name="btnRadio" id="chartTypeMonth" autocomplete="off">
                                    <label class="btn btn-outline-primary scaleHover bi bi-calendar-month" for="chartTypeMonth" th:text="'  ' + #{chart.month.button.label}">Month</label>

                                    <input type="radio" class="btn-check" name="btnRadio" id="chartTypeYear" autocomplete="off">
                                    <label class="btn btn-outline-primary scaleHover bi bi-calendar3" for="chartTypeYear" th:text="'  ' + #{chart.year.button.label}">Year</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script type="text/javascript" th:inline="javascript">
                        window.addEventListener("load", function() {
                          initChart();
                        });

                        var buttonTabId = document.getElementById('nav' + '[[${client.getId()}]]' + 'tab');
                        buttonTabId.addEventListener("click", function () {
                          initChart();
                        });

                        var switchChartId = document.getElementById('switchChart');
                        switchChartId.addEventListener("click", function () {
                          toggleChart();
                        });

                        var fromFirstDay = parseInt('[(${#temporals.format(weekFirstDay, 'dd')})]');
                        var toLastDay = parseInt('[(${#temporals.format(weekLastDay, 'dd')})]');
                        var daysOfWeekNumbers = [];
                        for (var i = fromFirstDay; i <= toLastDay; i++) {
                          daysOfWeekNumbers.push(i);
                        }

                        var daysOfWeekLabels = [];
                        /*[# th:each="weekLabel : ${weeklyStats}"]*/
                            daysOfWeekLabels.push('[(${weekLabel.key})]'.concat(' (').concat(daysOfWeekNumbers['[(${weekLabelStat.index})]']).concat(')'));
                        /*[/]*/

                        var weekIndexes = [];
                        /*[# th:each="index : ${weeklyStats}"]*/
                            weekIndexes.push('[(${index.value})]');
                        /*[/]*/

                        const canvas = document.getElementById('indexChart' + '[[${client.getId()}]]');
                        const ctx = canvas.getContext('2d');
                        var myChart;
                        var chartType = 'line';
                        var chart_labels = daysOfWeekLabels;
                        var temp_dataset = weekIndexes;

                        var data = {
                          labels: chart_labels,
                          datasets: [{
                            label: '[(#{chart.title})]',
                            fill: true,
                            lineTension: 0.1,
                            backgroundColor: 'rgba(161, 198, 247, 1)',
                            borderColor: 'rgb(47, 128, 237)',
                            borderCapStyle: 'square',
                            pointBorderColor: "white",
                            pointBackgroundColor: "green",
                            pointBorderWidth: 1,
                            pointHoverRadius: 8,
                            pointHoverBackgroundColor: "yellow",
                            pointHoverBorderColor: "green",
                            pointHoverBorderWidth: 2,
                            pointRadius: 4,
                            pointHitRadius: 10,
                            data: temp_dataset,
                            spanGaps: true,
                          }]
                        };

                        var options = {
                          scales: {
                            yAxes: [{
                              ticks: {
                                beginAtZero: true
                              }
                            }]
                          },
                          title: {
                            fontSize: 15,
                            display: true,
                            text: '[(#{chart.title.week.text(${#temporals.format(weekFirstDay, 'dd-MM-yyyy')}, ${#temporals.format(weekLastDay, 'dd-MM-yyyy')})})]',
                            position: 'top'
                          },
                          legend: {
                            display: true,
                            position: 'top',
                          }
                        };

                        function initChart() {
                          myChart = new Chart(ctx, {
                            type: chartType,
                            data: data,
                            options: options
                          });
                        }

                        function toggleChart() {
                          const currentChartTitle = myChart.options.title.text;
                          myChart.destroy();
                          this.chartType = (this.chartType == 'line') ? 'bar' : 'line';
                          initChart();
                          myChart.options.title.text = currentChartTitle;
                        }

                        function removeDataSet(ds1) {
                          let removalIndex = data.datasets.indexOf(ds1);
                          if(removalIndex >= 0) {
                            data.datasets.splice(removalIndex, 1);
                          }
                        }

                        // chart within the current week
                        var weekChart = document.getElementById('chartTypeWeek');
                        weekChart.addEventListener("click", function () {
                          chart_labels = daysOfWeekLabels;
                          temp_dataset = weekIndexes;
                          myChart.data.labels = chart_labels;
                          myChart.data.datasets[0].data = temp_dataset;
                          myChart.data.datasets[0].label = '[(#{chart.title})]';
                          myChart.options.title.text = '[(#{chart.title.week.text(${#temporals.format(weekFirstDay, 'dd-MM-yyyy')}, ${#temporals.format(weekLastDay, 'dd-MM-yyyy')})})]';
                          removeDataSet(myChart.data.datasets[1]);
                          myChart.update();
                        });

                        // chart within the current month
                        var monthChart = document.getElementById('chartTypeMonth');
                        monthChart.addEventListener("click", function () {
                          var daysOfMonthNumbers = [];
                          /*[# th:each="index : ${monthlyStats}"]*/
                            daysOfMonthNumbers.push('[(${index.key})]');
                          /*[/]*/

                          var monthIndexes = [];
                          /*[# th:each="index : ${monthlyStats}"]*/
                            monthIndexes.push('[(${index.value})]');
                          /*[/]*/

                          chart_labels = daysOfMonthNumbers;
                          temp_dataset = monthIndexes;
                          myChart.data.labels = chart_labels;
                          myChart.data.datasets[0].data = temp_dataset;
                          myChart.data.datasets[0].label = '[(#{chart.title})]';
                          myChart.options.title.text = '[(#{chart.title.month.text(${currentMonth})})]';
                          removeDataSet(myChart.data.datasets[1]);
                          myChart.update();
                        });

                        // chart within the current year
                        var yearChart = document.getElementById('chartTypeYear');
                        yearChart.addEventListener("click", function () {
                          var monthsOfYearLabels = [];
                          /*[# th:each="index : ${monthlyMinValues}"]*/
                            monthsOfYearLabels.push('[(${index.key})]');
                          /*[/]*/

                          var yearMinIndexes = [];
                          /*[# th:each="index : ${monthlyMinValues}"]*/
                            yearMinIndexes.push('[(${index.value})]');
                          /*[/]*/

                          var yearMaxIndexes = [];
                          /*[# th:each="index : ${monthlyMaxValues}"]*/
                            yearMaxIndexes.push('[(${index.value})]');
                          /*[/]*/

                          chart_labels = monthsOfYearLabels;
                          temp_dataset1 = yearMinIndexes;
                          temp_dataset2 = yearMaxIndexes;
                          myChart.data.labels = chart_labels;
                          myChart.data.datasets[0].data = temp_dataset1;
                          myChart.data.datasets[0].label = '[(#{chart.minMax.title(Min)})]';
                          myChart.data.datasets[1] = {
                            label: '[(#{chart.minMax.title(Max)})]',
                            fill: true,
                            lineTension: 0.1,
                            backgroundColor: 'rgba(247, 198, 161, 1)',
                            borderColor: 'rgb(237, 128, 47)',
                            borderCapStyle: 'square',
                            pointBorderColor: "white",
                            pointBackgroundColor: "green",
                            pointBorderWidth: 1,
                            pointHoverRadius: 8,
                            pointHoverBackgroundColor: "yellow",
                            pointHoverBorderColor: "green",
                            pointHoverBorderWidth: 2,
                            pointRadius: 4,
                            pointHitRadius: 10,
                            data: temp_dataset2,
                            spanGaps: true,
                          };
                          myChart.options.title.text = '[(#{chart.title.year.text})]';
                          myChart.update();
                        });
                    </script>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="modal fade" id="deleteBackdrop" role="dialog" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="deleteBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteBackdropLabel" th:text="#{electricity.deleteConfirmation.title}">Delete?</h5>
            </div>
            <div class="modal-body">
                <p class="modal-text" th:text="#{electricity.deleteConfirmation.content}">Confirm delete</p>
            </div>
            <div class="modal-footer d-flex justify-content-center">
                <a class="btn btn-secondary scaleHover" href="#" th:href="@{/user/dashboard/__${branch}__}" th:text="#{electricity.deleteConfirmation.cancel.label}">Cancel</a>
                <a href="#" id="setDelete" th:id="setDelete" class="btn btn-primary scaleHover" th:text="#{electricity.deleteConfirmation.submit.label}">Delete</a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.js"></script>

<script src="https://code.jquery.com/jquery-2.2.4.js" integrity="sha256-iT6Q9iMJYuQiMWNd9lDyBUStIq/8PuOW33aOqmvFpqI=" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
        crossorigin="anonymous"></script>

<script th:src="@{/scripts/electricity.js}" src="../static/scripts/electricity.js"></script>

</body>
</html>
